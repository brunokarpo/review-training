sudo: required
language: java
services:
  - docker

env:
  global:
    - SHA=$(git rev-parse --short HEAD)
    - DATETIME=$(date +"%y%m%d%H%M%S")
    - TAG=$DATETIME-$SHA

addons:
  sonarcloud:
    organization: "brunokarpo"
    token:
      secure: "$SONAR_TOKEN"

script:
  - ./mvnw clean install
  - sonar-scanner

after_success:
  - docker image build -f app/src/main/docker/Dockerfile.jvm -t brunokarpo/review-app:latest -t brunokarpo/review-app:$TAG app/.

before_deploy:
  - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin

deploy:
  provider: script
  script: bash ./deploy.sh
  on:
    branch: master